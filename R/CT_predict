#' Cell type annotation for N times with multiple LLM providers
#'
#' Annotate cell types using Large Language Models (LLMs) from different providers 
#' (OpenAI GPT, Anthropic Claude, Google Gemini, or DeepSeek) for multiple times 
#' with a gene list. One cell type is identified for each element in the list.
#' 
#' @param N Repeat run times (number of iterations).
#' @param marker A list of genes (marker genes for cell type identification).
#' @param tissueName Optional input of tissue name to provide context for annotation.
#' @param provider Character string specifying the LLM provider. Must be one of:
#'   \itemize{
#'     \item \code{"gpt"} - OpenAI GPT models
#'     \item \code{"claude"} - Anthropic Claude models
#'     \item \code{"gemini"} - Google Gemini models
#'     \item \code{"deepseek"} - DeepSeek models
#'   }
#' @param model Optional model version specification. If NULL, uses default models:
#'   \itemize{
#'     \item GPT: "gpt-4"
#'     \item Claude: "claude-sonnet-4-20250514"
#'     \item Gemini: "gemini-pro"
#'     \item DeepSeek: "deepseek-chat"
#'   }
#'   For custom models, see provider documentation:
#'   \itemize{
#'     \item OpenAI: https://platform.openai.com/docs/models
#'     \item Anthropic: https://docs.anthropic.com/claude/docs/models-overview
#'     \item Google: https://ai.google.dev/models/gemini
#'     \item DeepSeek: https://platform.deepseek.com/api-docs/
#'   }
#' @param seed Optional random seed for reproducibility. If NULL, uses default seeds:
#'   \itemize{
#'     \item GPT: 2024123456
#'     \item Claude/Gemini/DeepSeek: 20251118
#'   }
#'
#' @details 
#' This function requires appropriate API keys to be set in the system environment:
#' \itemize{
#'   \item OpenAI GPT: Set \code{OPENAI_API_KEY} (obtain from https://platform.openai.com/account/api-keys)
#'   \item Anthropic Claude: Set \code{ANTHROPIC_API_KEY} (obtain from https://console.anthropic.com/)
#'   \item Google Gemini: Set \code{GOOGLE_API_KEY} (obtain from https://ai.google.dev/)
#'   \item DeepSeek: Set \code{DEEPSEEK_API_KEY} (obtain from https://platform.deepseek.com/)
#' }
#' 
#' If an API key is set to '', the function will output the prompt itself instead of 
#' making API calls. If an actual key is provided, the output will be the cell type 
#' annotations from the specified model.
#'
#' @return A data frame of cell types with N columns, where each column represents 
#'   results from one iteration. Rows correspond to input marker gene sets.
#'   
#' @author Wen Tang <wxt175@@case.edu>
#' 
#' @examples 
#' # Load example data
#' data("marker_PBMC")
#' 
#' # Using OpenAI GPT with default settings
#' predict_gpt <- CT_predict(N = 3, marker = marker_PBMC, 
#'                           tissueName = 'PBMC', provider = 'gpt')
#' 
#' # Using Claude with custom model
#' predict_claude <- CT_predict(N = 3, marker = marker_PBMC, 
#'                              tissueName = 'PBMC', provider = 'claude',
#'                              model = 'claude-opus-4-20250514')
#' 
#' # Using Gemini with custom seed
#' predict_gemini <- CT_predict(N = 5, marker = marker_PBMC, 
#'                              provider = 'gemini', seed = 12345)
#' 
#' # Using DeepSeek with all custom parameters
#' predict_deepseek <- CT_predict(N = 3, marker = marker_PBMC, 
#'                                tissueName = 'PBMC', provider = 'deepseek',
#'                                model = 'deepseek-coder', seed = 99999)
#' 
#' @export
CT_predict <- function(N, marker, tissueName = NULL, 
                       provider = c("gpt", "claude", "gemini", "deepseek"),
                       model = NULL,
                       seed = NULL) {
  
  # Match the provider argument
  provider <- match.arg(provider)
  
  # Set default models if not specified
  if (is.null(model)) {
    model <- switch(provider,
                   gpt = "gpt-4",
                   claude = "claude-sonnet-4-20250514",
                   gemini = "gemini-pro",
                   deepseek = "deepseek-chat")
  }
  
  # Set default seed if not specified (matching your original functions)
  if (is.null(seed)) {
    seed <- ifelse(provider == "gpt", 2024123456, 20251118)
  }
  
  # Set the seed
  set.seed(seed)
  
  # Select the appropriate annotation function
  anno_function <- switch(provider,
                         gpt = gptcelltypeanno,
                         claude = claudecelltypeanno,
                         gemini = geminicelltypeanno,
                         deepseek = deepseekcelltypeanno)
  
  # Initialize a list to store results
  results_list <- list()
  
  # Run the function multiple times
  for (i in 1:N) {
    result <- anno_function(input = marker, 
                           model = model, 
                           tissuename = tissueName)
    results_list[[i]] <- result
  }
  
  # Combine results column-wise using cbind
  combined_results <- do.call(cbind, results_list)
  Anno_results <- data.frame(combined_results)
  
  return(Anno_results)
}
